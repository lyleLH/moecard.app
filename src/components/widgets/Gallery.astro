---
import 'swiper/css';
import 'swiper/css/effect-cards';
import 'swiper/css/pagination';
import 'swiper/css/grid';
import 'photoswipe/style.css';
import Twemoji from '../common/Twemoji.astro';
import { getLangFromUrl, useTranslations } from '~/i18n/utils';

interface Props {
  title?: string;
  subtitle?: string;
  images: {
    src: string;
    alt: string;
  }[];
  classes?: {
    container?: string;
    title?: string;
    subtitle?: string;
    grid?: string;
  };
}

const {
  title = '',
  subtitle = '',
  images = [],
  classes = {},
} = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<section class:list={['relative overflow-hidden', classes?.container]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6">
    {title && (
      <h2 class:list={['text-center mb-4 flex items-center justify-center gap-2', classes?.title]}>
        <Twemoji emoji="ğŸ¨" />
        {t('gallery.title')}
      </h2>
    )}
    {subtitle && (
      <p class:list={['text-center mb-8', classes?.subtitle]}>
        {t('gallery.subtitle')}
      </p>
    )}
    
    <!-- æ»‘åŠ¨æç¤º -->
    <div class="text-center mb-8 text-gray-500 dark:text-gray-400 flex items-center justify-center gap-2">
      <Twemoji emoji="ğŸ‘†" />
      <span>{lang === 'zh' ? 'å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šç²¾å½©ä½œå“' : 'Swipe left or right to see more works'}</span>
      <Twemoji emoji="âœ¨" />
    </div>
    
    <div class="swiper gallery-swiper">
      <div class="swiper-wrapper">
        {images.map((image) => (
          <div class="swiper-slide">
            <a 
              href={image.src}
              class="gallery-item block relative group overflow-hidden rounded-2xl shadow-md hover:shadow-xl transition-all duration-300"
              data-pswp-width="1200"
              data-pswp-height="1600"
            >
              <div class="aspect-[3/4]">
                <img
                  src={image.src}
                  alt={image.alt}
                  class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                  loading="lazy"
                  decoding="async"
                />
                <div class="absolute inset-0 bg-black opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
              </div>
            </a>
          </div>
        ))}
      </div>
    </div>
    
    <!-- åˆ†é¡µæŒ‡ç¤ºå™¨ -->
    <div class="swiper-pagination mt-8"></div>
  </div>
</section>

<script>
import Swiper from 'swiper';
import { Grid, Pagination, Autoplay } from 'swiper/modules';
import PhotoSwipe from 'photoswipe';
import PhotoSwipeLightbox from 'photoswipe/lightbox';

function initializeGallery() {
  // é”€æ¯å·²å­˜åœ¨çš„ Swiper å®ä¾‹
  const existingSwiperElement = document.querySelector('.gallery-swiper');
  const existingSwiper = (existingSwiperElement as any)?.swiper;
  if (existingSwiper) {
    existingSwiper.destroy(true, true);
  }

  // åˆå§‹åŒ– Swiper
  new Swiper('.gallery-swiper', {
    modules: [Grid, Pagination, Autoplay],
    slidesPerView: 1.2,
    grid: {
      rows: 2,
      fill: 'row'
    },
    spaceBetween: 16,
    centeredSlides: true,
    loop: true,
    speed: 1000,
    autoplay: {
      delay: 3000,
      disableOnInteraction: false,
      pauseOnMouseEnter: true,
    },
    pagination: {
      el: '.swiper-pagination',
      clickable: true,
      dynamicBullets: true,
      dynamicMainBullets: 3,
      renderBullet: function (index, className) {
        return '<span class="' + className + '"><span class="dot"></span></span>';
      },
    },
    breakpoints: {
      640: {
        slidesPerView: 2.2,
        spaceBetween: 20,
      },
      768: {
        slidesPerView: 3.2,
        spaceBetween: 24,
      },
      1024: {
        slidesPerView: 4.2,
        spaceBetween: 24,
      },
    },
  });

  // åˆå§‹åŒ– PhotoSwipe
  const existingLightbox = document.querySelector('.pswp');
  if (existingLightbox) {
    existingLightbox.remove();
  }

  const lightbox = new PhotoSwipeLightbox({
    gallery: 'section',
    children: '.gallery-item',
    pswpModule: PhotoSwipe,
    padding: { top: 30, bottom: 30, left: 10, right: 10 },
    bgOpacity: 0.9,
    showHideAnimationType: 'fade',
  });

  lightbox.init();
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initializeGallery);

// è§†å›¾è½¬æ¢åé‡æ–°åˆå§‹åŒ–
document.addEventListener('astro:after-swap', initializeGallery);

// é¡µé¢å®Œå…¨åŠ è½½ååˆå§‹åŒ–
if (document.readyState === 'complete') {
  initializeGallery();
}

// ç¡®ä¿åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('astro:page-load', initializeGallery);
</script>

<style>
/* Swiper è‡ªå®šä¹‰æ ·å¼ */
.swiper {
  width: 100%;
  padding: 32px 0;
}

.swiper-slide {
  height: calc((100% - 16px) / 2) !important;
  transition: transform 0.3s;
}

:global(.swiper-slide-active) {
  transform: scale(1.05);
}

/* åˆ†é¡µå™¨æ ·å¼ */
:global(.swiper-pagination) {
  position: relative !important;
  bottom: 0 !important;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  padding: 8px 0;
}

:global(.swiper-pagination-bullet) {
  width: 32px !important;
  height: 32px !important;
  background: transparent !important;
  opacity: 1 !important;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

:global(.swiper-pagination-bullet .dot) {
  width: 10px;
  height: 10px;
  background: #D1D5DB;
  border-radius: 50%;
  transition: all 0.3s;
}

:global(.swiper-pagination-bullet-active) {
  background: rgba(16, 185, 129, 0.1) !important;
  border-radius: 50%;
}

:global(.swiper-pagination-bullet-active .dot) {
  background: #10B981;
  transform: scale(1.2);
}

/* PhotoSwipe è‡ªå®šä¹‰ä¸»é¢˜ */
:global(.pswp) {
  --pswp-bg: #000;
  --pswp-error-text-color: #fff;
  --pswp-icon-color: #fff;
  --pswp-icon-color-secondary: #4b5563;
}

:global(.pswp__counter) {
  font-size: 14px;
  opacity: 0.85;
}

:global(.pswp__button) {
  opacity: 0.8;
  transition: opacity 0.2s;
}

:global(.pswp__button:hover) {
  opacity: 1;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
  .swiper {
    padding: 16px 0;
  }
  
  .swiper-slide {
    height: calc((100% - 8px) / 2) !important;
  }

  :global(.swiper-pagination-bullet) {
    width: 24px !important;
    height: 24px !important;
  }
}
</style>